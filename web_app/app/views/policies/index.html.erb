<script>
  const socket = new WebSocket('ws://localhost:3000/cable');

  socket.onopen = function(event) {
    const subscribe_msg = {
      command: 'subscribe',
      identifier: JSON.stringify({channel: 'PaymentUpdatesChannel'}),
    };
    socket.send(JSON.stringify(subscribe_msg));
  }

  socket.onmessage = function(event) {
    const data = JSON.parse(event.data);

    if (data.type === "ping") { return; }
    if (data.message) {
      updatedPolicy = JSON.parse(data.message);

      const policyId = updatedPolicy.id;
      const status = updatedPolicy.status;

      policy = document.getElementById(`status-${policyId}`)
      policy.innerHTML = status.fontcolor("green");

      alert = document.getElementById("policy-updated")
      alert.removeAttribute("hidden");
      alert.insertAdjacentHTML("beforeend", `Policy with identifier number ${policyId} was paid successfully`);
    }
    console.log("Received data from server", JSON.parse(event.data));
  };

  const msg = {
    command: 'message',
    identifier: JSON.stringify({channel: 'PaymentUpdatesChannel'}),
    data: JSON.stringify({'message': 'Hi'})
  }

  document.addEventListener('DOMContentLoaded', () => {
    (document.querySelectorAll('.notification .delete') || []).forEach(($delete) => {
      const $notification = $delete.parentNode;

      $delete.addEventListener('click', () => {
        $notification.parentNode.removeChild($notification);
      });
    });
  });
</script>

<div class="home-container">
  <h1>Home</h1>
  <% if current_user %>
  <h2><%= "Hello " + current_user.name %></h2>
  <%= link_to "Edit Account", edit_user_registration_path, class: "home-link" %>
  <h3>Policies List</h3>
  <% if @policies %>
    <table class="home-table">
      <thead>
        <th>ID</th>
        <th>Insured Name</th>
        <th>CPF</th>
        <th>Vehicle Plate</th>
        <th>Vehicle Brand and Model</th>
        <th>Insured at</th>
        <th>Insured until</th>
        <th>Status</th>
        <th>Payment Link</th>
      </thead>
      <tbody>
        <% @policies.each do |policy| %>
          <tr>
            <td><%= policy[:id] %></td>
            <td><%= policy[:insured][:name] %></td>
            <td><%= policy[:insured][:cpf] %></td>
            <td><%= policy[:vehicle][:plate] %></td>
            <td><%= policy[:vehicle][:brand] %> <%= policy[:vehicle][:model] %></td>
            <td><%= policy[:issuedDate] %></td>
            <td><%= policy[:endCoverageDate] %></td>
            <td id="status-<%= policy[:id] %>"><%= policy[:status] %></td>
            <td style="max-width: 200px; overflow: hidden;">
              <a href="<%= policy[:paymentLink] %>" target="_blank"><%= policy[:paymentLink] %></a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <% else %>
      <p> No Policies were found </p>
    <% end %>
  <%= link_to 'Create Policy', new_policy_path, class: "home-link" %>
  <%= button_to "Logout", destroy_user_session_path,class: "home-button", data: {turbo: false}, method: :delete %>
  <% else %>
    <%= link_to "Login", new_user_session_path %>
    <%= link_to "Create Account", new_user_registration_path %>
  <%end%>
</div>